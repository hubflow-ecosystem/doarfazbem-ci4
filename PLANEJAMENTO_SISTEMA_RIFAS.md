# Sistema de Rifas "N√∫meros da Sorte" - DoarFazBem

## Vis√£o Geral

Sistema de rifas digitais integrado √† plataforma DoarFazBem, onde compradores adquirem "Cotas de Apoio" (eBooks) que d√£o direito a n√∫meros da sorte para concorrer a pr√™mios. O comprador escolhe at√© 5 campanhas para receber parte do valor.

---

## 1. Estrutura Jur√≠dica

### Transforma√ß√£o MEI ‚Üí SLU

| Item | Detalhes |
|------|----------|
| CNPJ Atual | 53.367.693/0001-11 (MEI) |
| Novo Tipo | SLU - Sociedade Limitada Unipessoal |
| Prote√ß√£o | Bens pessoais separados da empresa |
| Custo Estimado | R$ 750 - R$ 1.500 |
| Prazo | 15-30 dias |
| Base Legal | Lei 13.874/2019 (Liberdade Econ√¥mica) |

---

## 2. Configura√ß√£o de Rifas

### 2.1 Tipos de Rifas por Quantidade de Cotas

| Tipo | Cotas | Arrecada√ß√£o Bruta (+10%) | Pr√™mio Principal (40%) |
|------|-------|--------------------------|------------------------|
| Bronze | 100.000 | R$ 110.000 | R$ 44.000 |
| Prata | 500.000 | R$ 550.000 | R$ 220.000 |
| Ouro | 1.000.000 | R$ 1.100.000 | R$ 440.000 |
| Diamante | 5.000.000 | R$ 5.500.000 | R$ 2.200.000 |
| Platina | 10.000.000 | R$ 11.000.000 | R$ 4.400.000 |

### 2.2 Tabela de Pre√ßos com Desconto Progressivo

| Quantidade | Valor/Cota | Total | Desconto |
|------------|------------|-------|----------|
| 1 cota | R$ 2,00 | R$ 2,00 | - |
| 5 cotas | R$ 1,80 | R$ 9,00 | 10% |
| 10 cotas | R$ 1,50 | R$ 15,00 | 25% |
| 25 cotas | R$ 1,20 | R$ 30,00 | 40% |
| 50 cotas | R$ 1,00 | R$ 50,00 | 50% |
| 100 cotas | R$ 0,90 | R$ 90,00 | 55% |
| 500 cotas | R$ 0,80 | R$ 400,00 | 60% |

**Pre√ßo m√©dio estimado: R$ 1,10/cota** (considerando distribui√ß√£o de compras)

---

## 3. Cotas Premiadas (Pr√™mios Instant√¢neos)

### 3.1 N√∫meros Repetidos (111111, 222222, etc.)

| N√∫mero | Pr√™mio Total | Comprador (50%) | Campanha (40%) | Plataforma (10%) |
|--------|--------------|-----------------|----------------|------------------|
| 000000 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 111111 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 222222 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 333333 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 444444 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 555555 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 666666 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 777777 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 888888 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 999999 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| **Total** | **R$ 10.000** | **R$ 5.000** | **R$ 4.000** | **R$ 1.000** |

### 3.2 Sequ√™ncias Especiais

| N√∫mero | Pr√™mio Total | Comprador (50%) | Campanha (40%) | Plataforma (10%) |
|--------|--------------|-----------------|----------------|------------------|
| 123456 | R$ 5.000 | R$ 2.500 | R$ 2.000 | R$ 500 |
| 654321 | R$ 5.000 | R$ 2.500 | R$ 2.000 | R$ 500 |
| **Total** | **R$ 10.000** | **R$ 5.000** | **R$ 4.000** | **R$ 1.000** |

### 3.3 N√∫meros "Bonitos"

| N√∫mero | Pr√™mio Total | Comprador (50%) | Campanha (40%) | Plataforma (10%) |
|--------|--------------|-----------------|----------------|------------------|
| 100000 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 200000 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 300000 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 400000 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 500000 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 600000 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 700000 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 800000 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| 900000 | R$ 1.000 | R$ 500 | R$ 400 | R$ 100 |
| **Total** | **R$ 9.000** | **R$ 4.500** | **R$ 3.600** | **R$ 900** |

### 3.4 Primeiro e √öltimo N√∫mero Vendido

| Tipo | Pr√™mio Total | Comprador (50%) | Campanha (40%) | Plataforma (10%) |
|------|--------------|-----------------|----------------|------------------|
| Primeiro vendido | R$ 5.000 | R$ 2.500 | R$ 2.000 | R$ 500 |
| √öltimo vendido | R$ 5.000 | R$ 2.500 | R$ 2.000 | R$ 500 |
| **Total** | **R$ 10.000** | **R$ 5.000** | **R$ 4.000** | **R$ 1.000** |

### 3.5 Resumo Cotas Premiadas (Rifa 1 Milh√£o)

| Categoria | Qtd Pr√™mios | Total Pr√™mios | Comprador | Campanha | Plataforma |
|-----------|-------------|---------------|-----------|----------|------------|
| Repetidos | 10 | R$ 10.000 | R$ 5.000 | R$ 4.000 | R$ 1.000 |
| Sequ√™ncias | 2 | R$ 10.000 | R$ 5.000 | R$ 4.000 | R$ 1.000 |
| Bonitos | 9 | R$ 9.000 | R$ 4.500 | R$ 3.600 | R$ 900 |
| Primeiro/√öltimo | 2 | R$ 10.000 | R$ 5.000 | R$ 4.000 | R$ 1.000 |
| **TOTAL** | **23** | **R$ 39.000** | **R$ 19.500** | **R$ 15.600** | **R$ 3.900** |

---

## 4. Ranking dos Maiores Compradores

### Top 3 - Pr√™mios

| Posi√ß√£o | Pr√™mio Total | Comprador (50%) | Campanha (40%) | Plataforma (10%) |
|---------|--------------|-----------------|----------------|------------------|
| 1¬∫ Lugar | R$ 5.000 | R$ 2.500 | R$ 2.000 | R$ 500 |
| 2¬∫ Lugar | R$ 3.000 | R$ 1.500 | R$ 1.200 | R$ 300 |
| 3¬∫ Lugar | R$ 2.000 | R$ 1.000 | R$ 800 | R$ 200 |
| **Total** | **R$ 10.000** | **R$ 5.000** | **R$ 4.000** | **R$ 1.000** |

---

## 5. Distribui√ß√£o Financeira Completa

### 5.1 Exemplo: Rifa OURO (1 Milh√£o de Cotas)

**Arrecada√ß√£o Bruta: R$ 1.100.000** (m√©dia R$ 1,10/cota)

#### Lado das Campanhas (40% = R$ 440.000)

| Item | C√°lculo | Valor |
|------|---------|-------|
| Valor Bruto Campanhas | 40% de R$ 1.100.000 | R$ 440.000 |
| (-) Gateway Mercado Pago (1% PIX) | 1% de R$ 1.100.000 | -R$ 11.000 |
| (-) Impostos (~15% sobre bruto) | 15% de R$ 1.100.000 | -R$ 165.000 |
| (-) Marketing (3%) | 3% de R$ 1.100.000 | -R$ 33.000 |
| **= L√≠quido para Campanhas** | | **R$ 231.000** |

*Distribu√≠do proporcionalmente entre at√© 5 campanhas escolhidas pelo comprador*

#### Lado da Plataforma (60% = R$ 660.000)

| Item | C√°lculo | Valor |
|------|---------|-------|
| Valor Bruto Plataforma | 60% de R$ 1.100.000 | R$ 660.000 |
| (-) Pr√™mio Principal (40% do bruto) | 40% de R$ 1.100.000 | -R$ 440.000 |
| (-) Cotas Premiadas | Ver se√ß√£o 3.5 | -R$ 39.000 |
| (-) Ranking Top 3 | Ver se√ß√£o 4 | -R$ 10.000 |
| (-) Reserva Pr√™mios (10% l√≠quido) | | -R$ 17.100 |
| **= Lucro L√≠quido Plataforma** | 10% livre | **R$ 153.900** |

### 5.2 Resumo Visual da Distribui√ß√£o

```
ARRECADA√á√ÉO TOTAL: R$ 1.100.000 (100%)
‚îú‚îÄ‚îÄ CAMPANHAS: R$ 440.000 (40%)
‚îÇ   ‚îú‚îÄ‚îÄ Gateway (1%): -R$ 11.000
‚îÇ   ‚îú‚îÄ‚îÄ Impostos (15%): -R$ 165.000
‚îÇ   ‚îú‚îÄ‚îÄ Marketing (3%): -R$ 33.000
‚îÇ   ‚îî‚îÄ‚îÄ L√çQUIDO: R$ 231.000 (21% do total)
‚îÇ
‚îî‚îÄ‚îÄ PLATAFORMA: R$ 660.000 (60%)
    ‚îú‚îÄ‚îÄ Pr√™mio Principal: -R$ 440.000 (40%)
    ‚îú‚îÄ‚îÄ Cotas Premiadas: -R$ 39.000 (3.5%)
    ‚îú‚îÄ‚îÄ Ranking Top 3: -R$ 10.000 (0.9%)
    ‚îú‚îÄ‚îÄ Reserva: -R$ 17.100 (1.6%)
    ‚îî‚îÄ‚îÄ LUCRO: R$ 153.900 (14% do total)
```

---

## 6. Sorteio pela Loteria Federal

### 6.1 M√©todo de Extra√ß√£o

Para 1 milh√£o de n√∫meros (000000 a 999999), usa-se combina√ß√£o dos pr√™mios:

| D√≠gitos | Fonte |
|---------|-------|
| 1¬∫ e 2¬∫ | √öltimos 2 d√≠gitos do 1¬∫ pr√™mio |
| 3¬∫ e 4¬∫ | √öltimos 2 d√≠gitos do 2¬∫ pr√™mio |
| 5¬∫ e 6¬∫ | √öltimos 2 d√≠gitos do 3¬∫ pr√™mio |

**Exemplo:**
- 1¬∫ Pr√™mio: 86957 ‚Üí **57**
- 2¬∫ Pr√™mio: 43281 ‚Üí **81**
- 3¬∫ Pr√™mio: 72634 ‚Üí **34**
- **N√∫mero Sorteado: 578134**

### 6.2 Cronograma do Sorteio

1. **100% das cotas vendidas** ‚Üí Sistema bloqueia vendas
2. **Pr√≥ximo sorteio da Loteria Federal** (quarta ou s√°bado)
3. **Apura√ß√£o autom√°tica** com resultado da Caixa
4. **Notifica√ß√£o imediata** via Push, E-mail e WhatsApp
5. **Pagamento em at√© 48h** via PIX

---

## 7. Notifica√ß√µes

### 7.1 Gatilhos de Notifica√ß√£o

| Evento | Push | E-mail | WhatsApp |
|--------|------|--------|----------|
| Compra confirmada | ‚úÖ | ‚úÖ | ‚úÖ |
| Cota premiada (instant√¢neo) | ‚úÖ | ‚úÖ | ‚úÖ |
| Rifa 10% vendida | ‚úÖ | ‚úÖ | ‚úÖ |
| Rifa 20% vendida | ‚úÖ | ‚úÖ | ‚úÖ |
| Rifa 30% vendida | ‚úÖ | ‚úÖ | ‚úÖ |
| Rifa 40% vendida | ‚úÖ | ‚úÖ | ‚úÖ |
| Rifa 50% vendida | ‚úÖ | ‚úÖ | ‚úÖ |
| Rifa 60% vendida | ‚úÖ | ‚úÖ | ‚úÖ |
| Rifa 70% vendida | ‚úÖ | ‚úÖ | ‚úÖ |
| Rifa 80% vendida | ‚úÖ | ‚úÖ | ‚úÖ |
| Rifa 90% vendida | ‚úÖ | ‚úÖ | ‚úÖ |
| Rifa 100% - Sorteio agendado | ‚úÖ | ‚úÖ | ‚úÖ |
| Resultado do sorteio | ‚úÖ | ‚úÖ | ‚úÖ |
| Voc√™ ganhou! | ‚úÖ | ‚úÖ | ‚úÖ |
| Entrou no Top 3 | ‚úÖ | ‚úÖ | ‚úÖ |
| Reserva expirando (5 min) | ‚úÖ | ‚ùå | ‚úÖ |
| Reserva expirada | ‚úÖ | ‚úÖ | ‚úÖ |

### 7.2 Integra√ß√£o WhatsApp

Todas as notifica√ß√µes ser√£o enviadas via WhatsApp utilizando API como:
- **Z-API** (recomendado)
- **Evolution API** (open source)
- **Twilio WhatsApp**

---

## 8. Sistema de Reserva de N√∫meros

### 8.1 Vis√£o Geral

Para evitar conflitos de compra simult√¢nea e garantir que os n√∫meros estejam dispon√≠veis quando o pagamento for confirmado, o sistema implementa um mecanismo de **reserva tempor√°ria**.

### 8.2 Regras de Reserva

| Par√¢metro | Valor |
|-----------|-------|
| **Tempo de reserva** | 30 minutos |
| **Aviso de expira√ß√£o** | 5 minutos antes |
| **Renova√ß√£o** | N√£o permitida |
| **Visualiza√ß√£o dos n√∫meros** | Somente ap√≥s pagamento confirmado |

### 8.3 Fluxo de Reserva

```
1. Usu√°rio seleciona quantidade de cotas
   ‚Üì
2. Sistema RESERVA n√∫meros aleat√≥rios (status: 'reserved')
   ‚Üì
3. Gera PIX com validade de 30 minutos
   ‚Üì
4. Timer de 30 minutos inicia
   ‚Üì
5. Usu√°rio v√™: "Voc√™ tem 30:00 para pagar"
   ‚Üì
6. [Se pagar em tempo]:
   ‚îÇ  ‚Üì
   ‚îÇ  Webhook confirma ‚Üí Status: 'paid'
   ‚îÇ  ‚Üì
   ‚îÇ  N√∫meros s√£o revelados ao comprador
   ‚îÇ  ‚Üì
   ‚îÇ  Notifica√ß√£o enviada com os n√∫meros
   ‚îÇ
7. [Se N√ÉO pagar]:
   ‚îÇ  ‚Üì
   ‚îÇ  25 min: Notifica√ß√£o "Faltam 5 minutos!"
   ‚îÇ  ‚Üì
   ‚îÇ  30 min: Reserva expira
   ‚îÇ  ‚Üì
   ‚îÇ  N√∫meros voltam para 'available'
   ‚îÇ  ‚Üì
   ‚îÇ  Compra cancelada automaticamente
```

### 8.4 Estados dos N√∫meros

| Status | Descri√ß√£o |
|--------|-----------|
| `available` | Dispon√≠vel para compra |
| `reserved` | Reservado aguardando pagamento (m√°x 30 min) |
| `paid` | Pago e confirmado |
| `expired` | Reserva expirou (volta para available) |

### 8.5 Estrutura de Dados para Reserva

```sql
-- Adicionar campos na tabela raffle_numbers
ALTER TABLE raffle_numbers ADD COLUMN status ENUM('available', 'reserved', 'paid', 'expired') DEFAULT 'available';
ALTER TABLE raffle_numbers ADD COLUMN reserved_at DATETIME NULL;
ALTER TABLE raffle_numbers ADD COLUMN reservation_expires_at DATETIME NULL;

-- √çndice para limpeza de reservas expiradas
CREATE INDEX idx_reservation_expires ON raffle_numbers (status, reservation_expires_at);
```

### 8.6 Job de Limpeza de Reservas

```php
// Executar a cada minuto via CRON
// Comando: php spark raffle:clean-expired-reservations

public function cleanExpiredReservations()
{
    $db = db_connect();

    // Buscar reservas expiradas
    $expired = $db->table('raffle_numbers')
        ->where('status', 'reserved')
        ->where('reservation_expires_at <', date('Y-m-d H:i:s'))
        ->get()
        ->getResultArray();

    foreach ($expired as $number) {
        // Voltar n√∫mero para dispon√≠vel
        $db->table('raffle_numbers')
            ->where('id', $number['id'])
            ->update(['status' => 'available', 'reserved_at' => null, 'reservation_expires_at' => null]);

        // Notificar usu√°rio que a reserva expirou
        $this->notifyReservationExpired($number['purchase_id']);
    }

    // Cancelar compras pendentes
    $db->table('raffle_purchases')
        ->where('payment_status', 'pending')
        ->where('created_at <', date('Y-m-d H:i:s', strtotime('-30 minutes')))
        ->update(['payment_status' => 'expired']);
}
```

### 8.7 Importante: N√∫meros N√ÉO s√£o mostrados antes do pagamento

- Durante a reserva, o comprador **N√ÉO v√™** quais n√∫meros foram reservados
- Apenas ap√≥s confirma√ß√£o do pagamento os n√∫meros s√£o revelados
- Isso evita que usu√°rios "pesquem" n√∫meros especiais sem pagar

### 8.8 Tela de Aguardando Pagamento

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                             ‚îÇ
‚îÇ      ‚è±Ô∏è Aguardando Pagamento               ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ      Tempo restante: 25:43                  ‚îÇ
‚îÇ      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 85%              ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ      10 cotas reservadas para voc√™         ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ      Os n√∫meros ser√£o revelados ap√≥s       ‚îÇ
‚îÇ      a confirma√ß√£o do pagamento.           ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ      [QR CODE PIX]                         ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ      Copie o c√≥digo PIX:                   ‚îÇ
‚îÇ      [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà] üìã             ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ      Total: R$ 15,00                        ‚îÇ
‚îÇ                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 9. Estrutura do Banco de Dados

### 9.1 Tabelas Necess√°rias

```sql
-- Rifas
CREATE TABLE raffles (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    total_numbers INT NOT NULL, -- 100000, 500000, 1000000, etc
    number_price DECIMAL(10,2) DEFAULT 1.10,
    main_prize_amount DECIMAL(15,2) NOT NULL,
    status ENUM('draft', 'active', 'sold_out', 'drawing', 'completed', 'cancelled') DEFAULT 'draft',
    sold_count INT DEFAULT 0,
    lottery_date DATE NULL,
    lottery_result VARCHAR(20) NULL,
    winning_number VARCHAR(10) NULL,
    winner_user_id INT UNSIGNED NULL,
    first_sold_number VARCHAR(10) NULL,
    first_sold_user_id INT UNSIGNED NULL,
    last_sold_number VARCHAR(10) NULL,
    last_sold_user_id INT UNSIGNED NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Pacotes de desconto
CREATE TABLE raffle_packages (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    raffle_id INT UNSIGNED NOT NULL,
    quantity INT NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL,
    discount_percent INT DEFAULT 0,
    is_active TINYINT(1) DEFAULT 1,
    FOREIGN KEY (raffle_id) REFERENCES raffles(id)
);

-- N√∫meros/Cotas compradas
CREATE TABLE raffle_numbers (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    raffle_id INT UNSIGNED NOT NULL,
    user_id INT UNSIGNED NULL,
    number VARCHAR(10) NOT NULL,
    purchase_id BIGINT UNSIGNED NOT NULL,
    is_special TINYINT(1) DEFAULT 0,
    special_type ENUM('repeated', 'sequence', 'round', 'first', 'last') NULL,
    special_prize DECIMAL(10,2) NULL,
    prize_paid TINYINT(1) DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_raffle_number (raffle_id, number),
    INDEX idx_user (user_id),
    FOREIGN KEY (raffle_id) REFERENCES raffles(id)
);

-- Compras de cotas
CREATE TABLE raffle_purchases (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    raffle_id INT UNSIGNED NOT NULL,
    user_id INT UNSIGNED NULL,
    buyer_name VARCHAR(255) NOT NULL,
    buyer_email VARCHAR(255) NOT NULL,
    buyer_phone VARCHAR(20) NULL,
    buyer_cpf VARCHAR(14) NOT NULL,
    quantity INT NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL,
    total_amount DECIMAL(15,2) NOT NULL,
    payment_method ENUM('pix') DEFAULT 'pix',
    payment_status ENUM('pending', 'paid', 'failed', 'refunded') DEFAULT 'pending',
    payment_id VARCHAR(255) NULL,
    pix_qr_code TEXT NULL,
    pix_copy_paste TEXT NULL,
    campaigns_selected JSON NULL, -- IDs das campanhas escolhidas
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    paid_at DATETIME NULL,
    FOREIGN KEY (raffle_id) REFERENCES raffles(id)
);

-- Distribui√ß√£o para campanhas
CREATE TABLE raffle_campaign_distributions (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    raffle_id INT UNSIGNED NOT NULL,
    purchase_id BIGINT UNSIGNED NOT NULL,
    campaign_id INT UNSIGNED NOT NULL,
    percentage DECIMAL(5,2) NOT NULL, -- % do valor destinado a esta campanha
    gross_amount DECIMAL(15,2) NOT NULL,
    net_amount DECIMAL(15,2) NOT NULL,
    status ENUM('pending', 'transferred', 'failed') DEFAULT 'pending',
    transferred_at DATETIME NULL,
    FOREIGN KEY (raffle_id) REFERENCES raffles(id),
    FOREIGN KEY (campaign_id) REFERENCES campaigns(id)
);

-- Pr√™mios das cotas especiais
CREATE TABLE raffle_special_prizes (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    raffle_id INT UNSIGNED NOT NULL,
    number_pattern VARCHAR(10) NOT NULL, -- Ex: 111111, 123456
    prize_type ENUM('repeated', 'sequence', 'round', 'first', 'last', 'ranking') NOT NULL,
    total_prize DECIMAL(10,2) NOT NULL,
    buyer_share DECIMAL(5,2) DEFAULT 50.00, -- %
    campaign_share DECIMAL(5,2) DEFAULT 40.00, -- %
    platform_share DECIMAL(5,2) DEFAULT 10.00, -- %
    is_claimed TINYINT(1) DEFAULT 0,
    claimed_by_user_id INT UNSIGNED NULL,
    claimed_at DATETIME NULL,
    FOREIGN KEY (raffle_id) REFERENCES raffles(id)
);

-- Ranking de compradores
CREATE TABLE raffle_rankings (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    raffle_id INT UNSIGNED NOT NULL,
    user_id INT UNSIGNED NOT NULL,
    total_purchased INT DEFAULT 0,
    total_spent DECIMAL(15,2) DEFAULT 0,
    rank_position INT NULL,
    prize_amount DECIMAL(10,2) NULL,
    prize_paid TINYINT(1) DEFAULT 0,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_raffle_user (raffle_id, user_id),
    FOREIGN KEY (raffle_id) REFERENCES raffles(id)
);
```

---

## 10. Fluxo de Compra

```
1. Usu√°rio acessa p√°gina da Rifa
   ‚Üì
2. Escolhe quantidade de cotas (1, 5, 10, 25, 50, 100, 500)
   ‚Üì
3. Sistema calcula valor com desconto
   ‚Üì
4. Usu√°rio seleciona at√© 5 campanhas para apoiar
   ‚Üì
5. Preenche dados (nome, email, CPF, telefone)
   ‚Üì
6. Gera PIX via Mercado Pago
   ‚Üì
7. Usu√°rio paga
   ‚Üì
8. Webhook confirma pagamento
   ‚Üì
9. Sistema sorteia n√∫meros aleat√≥rios
   ‚Üì
10. Verifica se algum √© especial (pr√™mio instant√¢neo)
    ‚Üì
11. Se especial ‚Üí Paga pr√™mio imediato + notifica
    ‚Üì
12. Atualiza ranking de compradores
    ‚Üì
13. Envia e-mail/push com n√∫meros
    ‚Üì
14. Quando 100% vendido ‚Üí Aguarda Loteria Federal
    ‚Üì
15. Apura resultado ‚Üí Paga vencedor
```

---

## 11. Cronograma de Implementa√ß√£o

### Fase 1: Banco de Dados (2-3 dias)
- [ ] Criar migrations para todas as tabelas
- [ ] Criar Models com relacionamentos
- [ ] Criar Seeds para dados de teste

### Fase 2: Backend - Controllers (3-4 dias)
- [ ] RaffleController (CRUD de rifas)
- [ ] RafflePurchaseController (compra de cotas)
- [ ] RaffleWebhookController (Mercado Pago)
- [ ] RaffleDrawController (apura√ß√£o)

### Fase 3: Integra√ß√£o Mercado Pago (2-3 dias)
- [ ] Configurar credenciais
- [ ] Implementar gera√ß√£o de PIX
- [ ] Implementar webhook de confirma√ß√£o
- [ ] Implementar pagamento de pr√™mios

### Fase 4: Frontend - Views (4-5 dias)
- [ ] P√°gina principal de rifas
- [ ] P√°gina de compra de cotas
- [ ] Sele√ß√£o de campanhas
- [ ] Confirma√ß√£o de pagamento
- [ ] Meus n√∫meros
- [ ] Resultado do sorteio

### Fase 5: Admin (2-3 dias)
- [ ] Dashboard de rifas
- [ ] Criar/editar rifas
- [ ] Visualizar vendas
- [ ] Apurar sorteio manualmente
- [ ] Relat√≥rios financeiros

### Fase 6: Notifica√ß√µes (2 dias)
- [ ] Templates de e-mail
- [ ] Push notifications
- [ ] Integra√ß√£o WhatsApp (Z-API ou similar)

### Fase 7: Testes e Ajustes (3-4 dias)
- [ ] Testes de compra
- [ ] Testes de sorteio
- [ ] Testes de pagamento
- [ ] Corre√ß√µes e otimiza√ß√µes

**Total Estimado: 18-24 dias de desenvolvimento**

---

## 12. Termos e Condi√ß√µes

O documento de Termos e Condi√ß√µes deve incluir:

1. **Natureza do produto**: Venda de eBook com brinde (n√∫mero da sorte)
2. **Distribui√ß√£o de valores**: Percentuais claros para cada destina√ß√£o
3. **Regras do sorteio**: Uso da Loteria Federal, datas, m√©todo
4. **Cotas premiadas**: Lista completa de n√∫meros especiais
5. **Prazo de pagamento**: At√© 48h via PIX
6. **Requisitos**: Maior de 18 anos, CPF v√°lido
7. **Campanhas beneficiadas**: Como funciona a escolha
8. **Cancelamento**: Pol√≠tica de reembolso
9. **Responsabilidades**: Limita√ß√µes da plataforma

---

## 13. Considera√ß√µes Legais

### 13.1 Modelo Jur√≠dico Adotado

- **Produto vendido**: eBook "Guia do Apoiador DoarFazBem"
- **Brinde**: N√∫mero da sorte para sorteio
- **Base legal**: Promo√ß√£o comercial (n√£o √© jogo de azar)
- **Sorteio**: Baseado em resultado p√∫blico (Loteria Federal)

### 13.2 Documenta√ß√£o Necess√°ria

- Regulamento da promo√ß√£o
- Termos de uso espec√≠ficos para rifas
- Pol√≠tica de privacidade atualizada
- Contrato social da SLU

---

*Documento criado em: <?= date('d/m/Y') ?>*
*Vers√£o: 1.0*
